╔════════════════════════════════════════════════════════════════════════════════════════════════════╗
║                    DOPAMINT INDEXER - COMPLETE ARCHITECTURE DIAGRAM                              ║
╚════════════════════════════════════════════════════════════════════════════════════════════════════╝

┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                              BLOCKCHAIN LAYER (Base Chain)                                      │
│                                                                                                 │
│  ┌─────────────────┐  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐       │
│  │   Factory       │  │   Payment        │  │   NFT Contract   │  │   NFT Contract   │ ...   │
│  │  0xFactory...   │  │  0xPayment...    │  │  0xNFT1...       │  │  0xNFT2...       │       │
│  │                 │  │                  │  │                  │  │                  │       │
│  │ Events:         │  │ Events:          │  │ Events:          │  │ Events:          │       │
│  │ • NFTCreated    │  │ • PaymentReceived│  │ • Transfer       │  │ • Transfer       │       │
│  │ • FeesUpdated   │  │ • Withdrawal     │  │ • Mint/Burn      │  │ • Mint/Burn      │       │
│  └────────┬────────┘  └────────┬─────────┘  └────────┬─────────┘  └────────┬─────────┘       │
│           │                    │                     │                     │                  │
│           └────────────────────┼─────────────────────┼─────────────────────┘                  │
│                                │                     │                                        │
│                                ▼ eth_getLogs()      │                                        │
│                        (Filtered by addresses)       │                                        │
└────────────────────────────────────────────────────────────────────────────────────────────────┘
                                 │
                                 │ RPC Requests with Address Filter
                                 ▼
┌────────────────────────────────────────────────────────────────────────────────────────────────┐
│                           DOPAMINT INDEXER LAYER (Go Application)                             │
│                                                                                                │
│  ┌──────────────────────────────────────────────────────────────────────────────────────┐    │
│  │  RPC Integration (src/utils/rpc_integration.go)                                      │    │
│  │  • Wraps Ethereum RPC client                                                         │    │
│  │  • Applies address filter dynamically                                                │    │
│  │  • Calculates efficiency metrics                                                     │    │
│  └────────────────┬─────────────────────────────────────────────────────────────────────┘    │
│                   │                                                                          │
│                   │ Filtered Log Streams                                                     │
│                   ▼                                                                          │
│  ┌──────────────────────────────────────────────────────────────────────────────────────┐    │
│  │  Contract Filter (src/filters/contract_filter.go)                                    │    │
│  │  ┌─────────────────────────────────────────────────────────────────────────────┐   │    │
│  │  │ Watched Addresses (Thread-safe):                                            │   │    │
│  │  │  • Factory: 0xFactory... (fixed)                                           │   │    │
│  │  │  • Payment: 0xPayment... (fixed)                                           │   │    │
│  │  │  • NFTs: [0xNFT1, 0xNFT2, ...] (dynamic, auto-populated)                   │   │    │
│  │  └─────────────────────────────────────────────────────────────────────────────┘   │    │
│  │                                                                                      │    │
│  │  Methods:                                                                           │    │
│  │  • ShouldIndexLog(address) → bool                                                  │    │
│  │  • AddNFTContract(address) → void                                                  │    │
│  │  • GetWatchedAddresses() → []Address                                               │    │
│  │  • StartMongoDBSync() → goroutine                                                  │    │
│  └────────────────┬──────────────────────────────────────────────────────────────────┘    │
│                   │                                                                        │
│                   │ Logs from Dopamint contracts only                                       │
│                   ▼                                                                        │
│  ┌──────────────────────────────────────────────────────────────────────────────────────┐  │
│  │  Event Listener (src/filters/event_listener.go)                                     │  │
│  │  ┌──────────────────────────────────────────────────────────────────────────────┐  │  │
│  │  │ Auto-Discovery:                                                              │  │  │
│  │  │ • Listen for: NFTContractCreated(uint256, address, address, string, ...)    │  │  │
│  │  │ • Extract: contractAddress from indexed parameter (Topic[1])                │  │  │
│  │  │ • Update: ContractFilter.AddNFTContract()                                   │  │  │
│  │  │ • Next RPC call: Automatically includes new address in filter               │  │  │
│  │  └──────────────────────────────────────────────────────────────────────────────┘  │  │
│  │                                                                                      │  │
│  │  Methods:                                                                           │  │
│  │  • ProcessLog(log) → void                                                          │  │
│  │  • ProcessLogs(logs[]) → int (count)                                               │  │
│  │  • ParseNFTContractCreatedEvent(log) → Event                                        │  │
│  │  • BackfillNFTContracts(ctx, logs[]) → error                                        │  │
│  └────────────────┬──────────────────────────────────────────────────────────────────┘  │
│                   │                                                                      │
│                   │ Also syncs with MongoDB                                              │
│                   ▼                                                                      │
│  ┌──────────────────────────────────────────────────────────────────────────────────────┐  │
│  │  MongoDB Integration (src/database/mongodb_client.go)                              │  │
│  │  ┌──────────────────────────────────────────────────────────────────────────────┐  │  │
│  │  │ Periodic Sync (Every 5 minutes):                                             │  │  │
│  │  │ 1. Query MongoDB nft_contracts collection                                    │  │  │
│  │  │ 2. Filter by status: "active"                                               │  │  │
│  │  │ 3. Extract contractAddress field                                             │  │  │
│  │  │ 4. Call ContractFilter.AddNFTContracts(addresses)                            │  │  │
│  │  │                                                                              │  │  │
│  │  │ Document structure:                                                         │  │  │
│  │  │ {                                                                            │  │  │
│  │  │   contractAddress: "0x...",                                                │  │  │
│  │  │   collectionId: 123,                                                        │  │  │
│  │  │   creator: "0x...",                                                         │  │  │
│  │  │   name: "Collection Name",                                                  │  │  │
│  │  │   symbol: "SYMBOL",                                                         │  │  │
│  │  │   baseURI: "ipfs://...",                                                    │  │  │
│  │  │   modelId: 1,                                                               │  │  │
│  │  │   status: "active",                                                         │  │  │
│  │  │   chainId: 8453,                                                            │  │  │
│  │  │   createdAt: Date,                                                          │  │  │
│  │  │   updatedAt: Date                                                           │  │  │
│  │  │ }                                                                            │  │  │
│  │  └──────────────────────────────────────────────────────────────────────────────┘  │  │
│  │                                                                                      │  │
│  │  Methods:                                                                           │  │
│  │  • GetNFTContractAddresses(ctx) → []Address                                         │  │
│  │  • GetActiveNFTContracts(ctx) → []Document                                          │  │
│  │  • UpsertNFTContract(ctx, contract) → error                                         │  │
│  │  • WatchNFTContracts(ctx, callback) → error                                         │  │
│  │  • GetStats(ctx) → map[string]interface{}                                           │  │
│  └────────────────┬──────────────────────────────────────────────────────────────────┘  │
│                   │                                                                      │
│                   │ Parsed Events                                                        │
│                   ▼                                                                      │
│  ┌──────────────────────────────────────────────────────────────────────────────────────┐  │
│  │  Event Parser & Log Formatter                                                       │  │
│  │  • Parse NFT Events: mint, burn, transfer                                          │  │
│  │  • Parse Payment Events: payment received, withdrawal                              │  │
│  │  • Format for ClickHouse insertion                                                 │  │
│  │  • Maintain full transaction history                                               │  │
│  └────────────────┬──────────────────────────────────────────────────────────────────┘  │
│                   │                                                                      │
└───────────────────┼──────────────────────────────────────────────────────────────────────┘
                    │
        ┌───────────┼──────────────┬────────────────────┬────────────────┐
        │           │              │                    │                │
        ▼           ▼              ▼                    ▼                ▼
┌────────────┐ ┌─────────┐ ┌──────────┐ ┌──────────┐ ┌─────────┐
│ClickHouse │ │ MongoDB │ │  Kafka   │ │  Redis   │ │ Prometheus │
│ Port 9000 │ │Port27017│ │Port 9092 │ │Port 6379 │ │ Port 9090  │
│            │ │         │ │          │ │          │ │            │
│ Tables:   │ │Coll:    │ │Topic:    │ │Cache:    │ │Metrics:    │
│ • blocks  │ │nft_     │ │dopamint- │ │NFT       │ │• Blocks/s  │
│ • txs     │ │contracts│ │blocks    │ │metadata  │ │• Events/s  │
│ • logs    │ │         │ │          │ │& temp    │ │• RPC calls │
│ • nft_    │ │Synced   │ │Streams   │ │data      │ │• Contracts│
│   events  │ │every    │ │processed │ │          │ │            │
│ • payment_│ │5 min    │ │events    │ │          │ │            │
│   events  │ │         │ │          │ │          │ │            │
└────┬───────┘ └────┬────┘ └──────────┘ └──────────┘ └──────┬─────┘
     │              │                                         │
     │              │                                         │
     └──────┬───────┴───────────────────────────────────────┬┘
            │                                               │
            ▼                                               ▼
    ┌──────────────────┐                          ┌──────────────────┐
    │  Query Layer     │                          │     Grafana      │
    │                  │                          │   Port 3000      │
    │ • Analytics      │                          │                  │
    │ • Aggregations   │                          │ • Dashboards     │
    │ • Reports        │                          │ • Metrics viz.   │
    │ • Export APIs    │                          │ • Alerts         │
    └──────────────────┘                          └──────────────────┘


╔════════════════════════════════════════════════════════════════════════════════════════════════════╗
║                                  DATA FLOW SUMMARY                                               ║
╠════════════════════════════════════════════════════════════════════════════════════════════════════╣
║                                                                                                    ║
║ 1. RPC Client fetches logs with FILTERED addresses (Factory, Payment, Auto-discovered NFTs)      ║
║    Efficiency: 99.99% data reduction (1M → 100 logs per 10K blocks)                              ║
║                                                                                                    ║
║ 2. Contract Filter maintains whitelist of watched addresses                                      ║
║    Updated by: Auto-discovery events + MongoDB periodic sync                                     ║
║                                                                                                    ║
║ 3. Event Listener monitors NFTContractCreated events                                             ║
║    Automatically adds new contracts to filter without manual intervention                        ║
║                                                                                                    ║
║ 4. MongoDB Sync pulls NFT contract list every 5 minutes                                          ║
║    Updates filter dynamically as new contracts are created in the backend                        ║
║                                                                                                    ║
║ 5. Parsed events stored in ClickHouse for analytics                                              ║
║    Indexed, queryable, and exportable for frontend consumption                                   ║
║                                                                                                    ║
║ 6. Metrics collected by Prometheus, visualized in Grafana                                        ║
║    Monitor: Indexing rate, contracts watched, database performance                              ║
║                                                                                                    ║
╚════════════════════════════════════════════════════════════════════════════════════════════════════╝


╔════════════════════════════════════════════════════════════════════════════════════════════════════╗
║                              FILTERING EFFICIENCY COMPARISON                                     ║
╠════════════════════════════════════════════════════════════════════════════════════════════════════╣
║                                                                                                    ║
║                        WITHOUT FILTERING        WITH DOPAMINT FILTERING        REDUCTION         ║
║  ─────────────────────────────────────────────────────────────────────────────────────────────   ║
║  Logs/10K blocks      ~1,000,000               ~100                          99.99%             ║
║  Storage/1M blocks    ~1TB                     ~10GB                         99%                ║
║  Memory usage         ~5GB                     ~500MB                        90%                ║
║  RPC calls/hour       10,000                   1,000                         90%                ║
║  Processing time      10 hours                 30 minutes                    95% faster         ║
║                                                                                                    ║
╚════════════════════════════════════════════════════════════════════════════════════════════════════╝
